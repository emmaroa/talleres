<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pedidos Almac√©n ‚Äî Consulta</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb;
      --turq:#10c6d1; --turq2:#0ea5b0; --orange:#ff7f11; --orange2:#f97316;
      --shadow: 0 12px 28px rgba(17,24,39,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{
      background:linear-gradient(90deg,var(--orange),var(--turq));
      color:#fff;padding:18px 16px;
    }
    header h1{margin:0;font-size:18px}
    header p{margin:6px 0 0;opacity:.9;font-size:13px}
    .wrap{max-width:1250px;margin:0 auto;padding:16px}
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
      box-shadow:var(--shadow);padding:14px
    }
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width: 980px){ .grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width: 520px){ .grid{grid-template-columns:1fr} }
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input{
      width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;
      outline:none;font-size:14px;background:#fff
    }
    input:focus{border-color:rgba(16,198,209,.6);box-shadow:0 0 0 4px rgba(16,198,209,.12)}
    .actions{display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap}
    button{
      border:0;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;font-size:14px
    }
    .btn-primary{background:var(--turq);color:#fff}
    .btn-primary:hover{background:var(--turq2)}
    .btn-orange{background:var(--orange);color:#fff}
    .btn-orange:hover{background:var(--orange2)}
    .btn-ghost{background:#fff;border:1px solid var(--border);color:var(--text)}
    .btn-ghost:hover{border-color:#cbd5e1}
    .meta{margin-left:auto;color:var(--muted);font-size:13px}
    .loading{display:none;margin-top:10px;color:var(--muted);font-size:13px}

    .table-wrap{margin-top:14px;overflow:auto;border:1px solid var(--border);border-radius:14px}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:1350px;background:#fff}
    thead th{
      position:sticky;top:0;background:#fafafa;border-bottom:1px solid var(--border);
      text-align:left;font-size:12px;color:#374151;padding:10px 12px;white-space:nowrap
    }
    tbody td{border-bottom:1px solid var(--border);padding:10px 12px;font-size:13px;vertical-align:top}
    tbody tr:hover{background:#fcfcff}
    .pill{
      display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;
      border:1px solid var(--border);font-size:12px;font-weight:900
    }
    .pill.orange{background:rgba(255,127,17,.10);border-color:rgba(255,127,17,.25)}
    .pill.turq{background:rgba(16,198,209,.10);border-color:rgba(16,198,209,.25)}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <h1>Pedidos de Almac√©n ‚Äî Consulta</h1>
    <p>Filtra por unidad, petici√≥n, qui√©n solicita y √°rea. Estatus vac√≠o = ‚ÄúPendiente‚Äù.</p>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="grid">
        <div>
          <label>Unidad</label>
          <input id="unidad" placeholder="Ej. 1-1, 3529, 3310..." />
        </div>
        <div>
          <label>Petici√≥n</label>
          <input id="peticion" placeholder="Ej. balatas, bater√≠a..." />
        </div>
        <div>
          <label>Qui√©n solicita</label>
          <input id="solicita" placeholder="Ej. Christian, V√≠ctor..." />
        </div>
        <div>
          <label>√Årea</label>
          <input id="area" placeholder="Ej. STOCK, TALLERES..." />
        </div>
      </div>

      <div class="actions">
        <button class="btn-primary" onclick="buscar()">Buscar</button>
        <button class="btn-ghost" onclick="limpiar()">Limpiar</button>
        <button class="btn-orange" onclick="ultimos5()">√öltimos 5</button>
        <button class="btn-ghost" onclick="copiarWhats()">Copiar WhatsApp</button>

        <div class="meta" id="meta">Listo.</div>
      </div>

      <div class="loading" id="loading">Cargando‚Ä¶</div>
      <div class="small" style="margin-top:8px;">Tip: puedes presionar <b>Enter</b> en cualquier campo para buscar.</div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>A Timestamp</th>
              <th>B Unidad</th>
              <th>C Petici√≥n</th>
              <th>D Qui√©n solicita</th>
              <th>G √Årea</th>
              <th>H Dependencia</th>
              <th>J Estatus</th>
              <th>L Recibido</th>
              <th>M Descripci√≥n</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="9" style="color:#6b7280;padding:14px;">Haz una b√∫squeda para ver resultados.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  // üîß Pega aqu√≠ tu URL de Apps Script (termina en /exec)
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzTpnJwFKYWU1PIHefJM2bRzeQqN9iseK_xiK_KYswRgn2YmSIeqLjWU6FvSPCZ50cw/exec";

  let lastRows = [];

  function qs(id){ return document.getElementById(id); }
  function val(id){ return (qs(id).value || '').trim(); }

  function setLoading(on){
    qs('loading').style.display = on ? 'block' : 'none';
    qs('meta').textContent = on ? 'Cargando‚Ä¶' : 'Listo.';
  }

  function escapeHtml(s){
    return String(s ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  function pillEstatus(text){
    const t = (text || '').toLowerCase();
    const cls = (t.includes('pend') || t.includes('proc')) ? 'orange' : 'turq';
    return `<span class="pill ${cls}">${escapeHtml(text)}</span>`;
  }

  function render(rows){
    lastRows = Array.isArray(rows) ? rows : [];
    const tb = qs('tbody');

    if (!lastRows.length){
      tb.innerHTML = `<tr><td colspan="9" style="color:#6b7280;padding:14px;">Sin resultados.</td></tr>`;
      qs('meta').textContent = 'Resultados: 0';
      return;
    }

    tb.innerHTML = lastRows.map(r => `
      <tr>
        <td>${escapeHtml(r.timestamp || '')}</td>
        <td>${escapeHtml(r.unidad || '')}</td>
        <td>${escapeHtml(r.peticion || '')}</td>
        <td>${escapeHtml(r.solicita || '')}</td>
        <td>${escapeHtml(r.area || '')}</td>
        <td>${escapeHtml(r.dependencia || '')}</td>
        <td>${pillEstatus(r.status || 'Pendiente')}</td>
        <td>${escapeHtml(r.recibido || '')}</td>
        <td>${escapeHtml(r.descripcion || '')}</td>
      </tr>
    `).join('');

    qs('meta').textContent = `Resultados: ${lastRows.length}`;
  }

  async function fetchJson(url){
    const res = await fetch(url, { method:'GET' });
    const txt = await res.text();
    try { return JSON.parse(txt); } catch { throw new Error('Respuesta no es JSON: ' + txt.slice(0,200)); }
  }

  async function buscar(){
    setLoading(true);

    const params = new URLSearchParams({
      action: 'search_pedidos',
      unidad: val('unidad'),
      peticion: val('peticion'),
      solicita: val('solicita'),
      area: val('area'),
      limit: '300'
    });

    try{
      const data = await fetchJson(`${SCRIPT_URL}?${params.toString()}`);
      if(!data.ok) throw new Error(data.error || 'Error desconocido');
      render(data.rows || []);
      setLoading(false);
    }catch(err){
      setLoading(false);
      qs('meta').textContent = 'Error';
      qs('tbody').innerHTML = `<tr><td colspan="9" style="color:#b91c1c;padding:14px;">${escapeHtml(err.message || err)}</td></tr>`;
    }
  }

  async function ultimos5(){
    setLoading(true);
    try{
      const data = await fetchJson(`${SCRIPT_URL}?action=latest_pedidos&limit=5`);
      if(!data.ok) throw new Error(data.error || 'Error desconocido');

      // Adaptamos al formato de tabla completa
      const rows = (data.items || []).map(x => ({
        timestamp: x.timestamp || '',
        unidad: x.unidad || '',
        peticion: x.peticion || '',
        solicita: x.solicita || '',
        area: '',              // latest no trae area (si quieres lo sumamos en tu script)
        dependencia: x.dependencia || '',
        status: x.status || 'Pendiente',
        recibido: '',
        descripcion: ''
      }));

      render(rows);
      setLoading(false);
    }catch(err){
      setLoading(false);
      qs('meta').textContent = 'Error';
      qs('tbody').innerHTML = `<tr><td colspan="9" style="color:#b91c1c;padding:14px;">${escapeHtml(err.message || err)}</td></tr>`;
    }
  }

  function limpiar(){
    ['unidad','peticion','solicita','area'].forEach(id => qs(id).value = '');
    lastRows = [];
    qs('tbody').innerHTML = `<tr><td colspan="9" style="color:#6b7280;padding:14px;">Haz una b√∫squeda para ver resultados.</td></tr>`;
    qs('meta').textContent = 'Listo.';
  }

  async function copiarWhats(){
    if(!lastRows.length){
      alert('No hay resultados para copiar.');
      return;
    }

    const lines = [];
    lines.push('üì¶ *PEDIDOS ALMAC√âN*');
    lines.push(`üïí ${new Date().toLocaleString('es-MX')}`);
    lines.push('--------------------------');

    lastRows.slice(0, 20).forEach((r, i) => {
      lines.push(
        `${i+1}) *${(r.unidad || '').trim()}* ‚Äî ${(r.peticion || '').trim()}\n` +
        `Solicita: ${(r.solicita || '').trim()} | √Årea: ${(r.area || '').trim()}\n` +
        `Estatus: ${(r.status || 'Pendiente').trim()} | Recibido: ${(r.recibido || '').trim()}`
      );
      lines.push('---');
    });

    const text = lines.join('\n');
    await navigator.clipboard.writeText(text);
    alert('‚úÖ Copiado. P√©galo en WhatsApp.');
  }

  // Enter para buscar
  ['unidad','peticion','solicita','area'].forEach(id => {
    qs(id).addEventListener('keydown', (e) => {
      if(e.key === 'Enter') buscar();
    });
  });
</script>
</body>
</html>

