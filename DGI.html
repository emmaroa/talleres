<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pedidos — Infraestructura</title>

<style>
:root{
  --bg:#f8f6f2;
  --card:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;

  --orange:#ff7f11;
  --turq:#10c6d1;

  --shadow:0 18px 45px rgba(17,24,39,.08);
  --radius:22px;
  --ring:rgba(16,198,209,.35);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
  background:
    radial-gradient(900px 500px at 100% -10%, rgba(16,198,209,.12), transparent 60%),
    radial-gradient(800px 500px at -10% 0%, rgba(255,127,17,.12), transparent 60%),
    var(--bg);
}

/* ===== Top Header ===== */
.container{max-width:1200px;margin:32px auto;padding:0 18px;}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:14px;
  padding:18px 22px;
  background:rgba(255,255,255,.85);
  backdrop-filter:blur(8px);
  border-radius:28px;
  border:1px solid var(--border);
  box-shadow:var(--shadow);
}

.brand{
  display:flex;
  align-items:center;
  gap:14px;
}

.logo{
  width:50px;height:50px;
  border-radius:18px;
  display:grid;place-items:center;
  background:linear-gradient(135deg, rgba(255,127,17,.2), rgba(16,198,209,.2));
  border:1px solid rgba(0,0,0,.06);
}

.logo img{width:44px;height:44px;object-fit:contain}

.title h1{margin:0;font-size:18px}
.title p{margin:2px 0 0;color:var(--muted);font-size:13px}

.toolbar{
  display:flex;
  gap:10px;
  align-items:center;
}

.pill{
  font-size:12px;
  padding:7px 12px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#fff;
  color:var(--muted);
}

.btn{
  padding:8px 14px;
  border-radius:14px;
  border:1px solid var(--border);
  background:#fff;
  cursor:pointer;
  font-weight:600;
  font-size:13px;
  transition:.15s ease;
}
.btn:hover{
  border-color:var(--turq);
  box-shadow:0 0 0 3px var(--ring);
}
.btn.primary{
  border-color:rgba(255,127,17,.4);
  background:linear-gradient(180deg, rgba(255,127,17,.15), rgba(255,127,17,.05));
}

/* ===== Card Table ===== */
.card{
  margin-top:18px;
  background:#fff;
  border-radius:28px;
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  overflow:hidden;
}

.card-header{
  padding:18px 22px 10px;
  border-bottom:1px solid var(--border);
  background:linear-gradient(180deg, rgba(255,127,17,.08), rgba(16,198,209,.05));
}

.card-header h2{margin:0;font-size:15px}
.card-header small{color:var(--muted)}

.status-line{
  padding:10px 22px;
  font-size:13px;
  color:var(--muted);
  display:flex;
  justify-content:space-between;
  flex-wrap:wrap;
}

.table-wrap{overflow:auto}

table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  min-width:1000px;
}

thead th{
  position:sticky;
  top:0;
  background:#fff;
  padding:12px;
  font-size:12px;
  text-align:left;
  color:var(--muted);
  border-bottom:1px solid var(--border);
}

tbody td{
  padding:12px;
  font-size:13px;
  border-bottom:1px solid #f1f5f9;
}

tbody tr:hover{
  background:rgba(16,198,209,.06);
}

.badge{
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:700;
  display:inline-block;
}

.b-ok{background:rgba(34,197,94,.12);color:#166534}
.b-warn{background:rgba(245,158,11,.15);color:#92400e}
.b-info{background:rgba(59,130,246,.15);color:#1e40af}
.b-bad{background:rgba(239,68,68,.15);color:#7f1d1d}
.b-muted{background:#f1f5f9;color:#475569}

footer{
  padding:14px;
  text-align:center;
  font-size:12px;
  color:var(--muted);
}
</style>
</head>
<body>

<div class="container">

  <div class="header">
    <div class="brand">
      <div class="logo">
        <img src="escudo.png" alt="" onerror="this.style.display='none'">
      </div>
      <div class="title">
        <h1>Pedidos — Infraestructura</h1>
        <p>Dirección de Talleres · Municipio de Hermosillo</p>
      </div>
    </div>

    <div class="toolbar">
      <div class="pill">Área: Infraestructura</div>
      <div class="pill">Últimos 100</div>
      <button class="btn primary" onclick="fetchData()">Actualizar</button>
      <button class="btn" onclick="copyTable()">Copiar</button>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2>Listado de Registros</h2>
      <small id="subtitle">Cargando…</small>
    </div>

    <div class="status-line">
      <span id="statusLine">Preparando…</span>
      <span id="lastUpdate"></span>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Unidad</th>
            <th>Petición</th>
            <th>Estatus</th>
            <th>Recepcion</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="5">Cargando datos…</td></tr>
        </tbody>
      </table>
    </div>

    <footer>© 2026 Dirección de Talleres</footer>
  </div>

</div>
<script>
const apiKey  = 'AIzaSyBuDCgUZi7USIvmh6xW8QAQCPsE0wjNi7A';
const sheetId = '1NSpI6iWqYbXmJvSFrZ5bPKIPTlIQ8V0wlqhUXUxPN2w';

const SHEET_NAME = 'PEDIDOS';
const LIMIT = 100;
const range = `${SHEET_NAME}!A:L`;
const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(range)}?key=${apiKey}`;

// Columna H (índice 7) contiene "Infraestructura"
const ONLY_DEP = "Infraestructura";

function norm(s){ return (s ?? "").toString().trim().toLowerCase(); }

function tryParseDate(v){
  if (!v) return null;
  const s = v.toString().trim();
  const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
  if (m){
    const dd = +m[1], MM = +m[2]-1, yyyy = +m[3];
    const hh = +m[4], mm = +m[5], ss = +(m[6]||0);
    const d = new Date(yyyy, MM, dd, hh, mm, ss);
    if (!Number.isNaN(d.getTime())) return d;
  }
  const d2 = new Date(v);
  if (!Number.isNaN(d2.getTime())) return d2;
  return null;
}

function fmtDate(v){
  const d = tryParseDate(v);
  if (!d) return (v ?? "").toString();
  const pad = (n)=> String(n).padStart(2,"0");
  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

function badge(statusRaw){
  const status = (statusRaw ?? "").toString().trim();
  const s = norm(status);

  if (!s) return `<span class="badge b-muted">—</span>`;
  if (s.includes("recib") || s.includes("entreg")) return `<span class="badge b-ok">${status}</span>`;
  if (s.includes("pend") || s.includes("esper") || s.includes("revision") || s.includes("revisión")) return `<span class="badge b-warn">${status}</span>`;
  if (s.includes("pedido") || s.includes("enviado") || s.includes("captur")) return `<span class="badge b-info">${status}</span>`;
  if (s.includes("cancel") || s.includes("rechaz") || s.includes("error")) return `<span class="badge b-bad">${status}</span>`;
  return `<span class="badge b-muted">${status}</span>`;
}

function nowFmt(){
  return new Date().toLocaleString("es-MX", { hour12:false });
}

function isInfraRow(r){
  // H = dependencia
  return norm(r[7]).includes(ONLY_DEP);
}

function esc(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

async function fetchData(){
  const statusLine = document.getElementById("statusLine");
  const subtitle   = document.getElementById("subtitle");
  const lastUpdate = document.getElementById("lastUpdate");
  const tbody      = document.getElementById("tbody");
  const btnRefresh = document.getElementById("btnRefresh");

  statusLine.textContent = "Cargando…";
  subtitle.textContent = "Leyendo base…";
  if (btnRefresh) btnRefresh.disabled = true;

  try{
    const resp = await fetch(apiUrl, { cache: "no-store" });
    if(!resp.ok) throw new Error(`HTTP ${resp.status}`);

    const json = await resp.json();
    const values = json.values || [];

    const rows = values.length ? values.slice(1) : [];

    const infra = rows
      .filter(isInfraRow)
      .sort((a,b) => (tryParseDate(b[0])?.getTime() || 0) - (tryParseDate(a[0])?.getTime() || 0))
      .slice(0, LIMIT);

    if(!infra.length){
      tbody.innerHTML = `<tr><td colspan="5" class="muted">
        No hay registros para Infraestructura (columna H).
      </td></tr>`;
      subtitle.textContent = "0 registros";
      statusLine.textContent = "OK (sin coincidencias)";
      lastUpdate.textContent = `Actualizado: ${nowFmt()}`;
      return;
    }

    tbody.innerHTML = infra.map(r => `
      <tr>
        <td>${esc(fmtDate(r[0]))}</td>
        <td><b>${esc(r[1])}</b></td>
        <td>${esc(r[2])}</td>
        <td>${badge(esc(r[9]))}</td>
        <td class="muted">${esc(r[11])}</td>
      </tr>
    `).join("");

    subtitle.textContent = `Mostrando ${infra.length} registros (Infraestructura)`;
    statusLine.textContent = "OK";
    lastUpdate.textContent = `Actualizado: ${nowFmt()}`;

  }catch(e){
    console.error(e);
    statusLine.textContent = `Error: ${e.message || e}`;
    subtitle.textContent = "No se pudo cargar";
    tbody.innerHTML = `<tr><td colspan="5" class="muted">
      Comunicate con Emma Figueroa.
    </td></tr>`;
  }finally{
    if (btnRefresh) btnRefresh.disabled = false;
  }
}

async function copyTable(){
  const rows = [...document.querySelectorAll("tbody tr")].map(tr =>
    [...tr.querySelectorAll("td")].map(td => td.innerText.replace(/\s+/g," ").trim()).join("\t")
  ).join("\n");
  await navigator.clipboard.writeText(rows);
}

window.fetchData = fetchData;
window.copyTable = copyTable;

fetchData();
</script>
