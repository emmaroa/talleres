<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Corregir y Extraer Datos CFDI SAT</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #fff8f0;
    color: #333;
    max-width: 700px;
    margin: 30px auto;
    padding: 20px;
    text-align: center;
  }
  textarea {
    width: 100%;
    height: 120px;
    padding: 10px;
    font-size: 16px;
    border: 2px solid #ffa94d;
    border-radius: 8px;
    resize: none;
  }
  button {
    margin-top: 15px;
    background-color: #ff7f2a;
    color: white;
    border: none;
    padding: 12px 25px;
    font-size: 16px;
    border-radius: 8px;
    cursor: pointer;
  }
  button:hover {
    background-color: #e36b00;
  }
  #resultado {
    margin-top: 25px;
    background: #fff2e0;
    border: 1px solid #ffc999;
    padding: 15px;
    border-radius: 10px;
    word-break: break-word;
    text-align: left;
  }
  #parametros {
    margin-top: 20px;
    text-align: left;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }
  .param {
    margin-bottom: 8px;
  }
  label {
    font-weight: bold;
  }
  input {
    width: 100%;
    padding: 6px 8px;
    font-size: 14px;
    border: 1px solid #ffa94d;
    border-radius: 6px;
    background-color: #fffdfb;
  }
  a#abrir {
    display: inline-block;
    margin-top: 15px;
    background-color: #ff914d;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
  }
  a#abrir:hover {
    background-color: #e36b00;
  }
</style>
</head>
<body>

<h1>üîß Corregir y Extraer Datos CFDI SAT</h1>
<p>Pega la cadena mal formada del lector QR y obt√©n la URL limpia y los datos para copiar.</p>

<textarea id="entrada" placeholder="Pega aqu√≠ el texto escaneado..."></textarea>
<br/>
<button onclick="procesarCadena()">Procesar</button>

<div id="resultado" style="display:none;">
  <h2>URL corregida</h2>
  <div id="urlCorregida"></div>
  <a id="abrir" href="#" target="_blank">üåê Abrir URL corregida</a>

  <div id="parametros">
    <h3>Par√°metros extra√≠dos</h3>
    <div class="param">
      <label for="id">id:</label>
      <input type="text" id="id" readonly />
    </div>
    <div class="param">
      <label for="re">re:</label>
      <input type="text" id="re" readonly />
    </div>
    <div class="param">
      <label for="rr">rr:</label>
      <input type="text" id="rr" readonly />
    </div>
    <div class="param">
      <label for="tt">tt:</label>
      <input type="text" id="tt" readonly />
    </div>
    <div class="param">
      <label for="fe">fe:</label>
      <input type="text" id="fe" readonly />
    </div>
  </div>
</div>

<script>
function procesarCadena() {
  const cadenaOriginal = document.getElementById("entrada").value;

  if (!cadenaOriginal.trim()) {
    alert("Por favor pega la cadena del lector QR.");
    return;
  }

  // Normalizar y limpiar
  let texto = cadenaOriginal.toLowerCase().replace(/\s+/g, "");

  const reemplazos = {
    "https√±--": "https://",
    "√±--": "://",
    "_": "/",
    "¬ø": "=",
    "¬°": "=",
    "'": "-",
  };

  for (const key in reemplazos) {
    texto = texto.split(key).join(reemplazos[key]);
  }

  function extraerValor(etiqueta) {
    const re = new RegExp(etiqueta + "=([^/&]+)", "i");
    const m = texto.match(re);
    return m ? m[1] : "";
  }

  const id = extraerValor("id");
  const re = extraerValor("re");
  const rr = extraerValor("rr");
  const tt = extraerValor("tt");
  const fe = extraerValor("fe");

  if (!id || !re || !rr || !tt || !fe) {
    alert("No se pudieron extraer todos los par√°metros necesarios.");
    return;
  }

  const urlFinal = `https://verificacfdi.facturaelectronica.sat.gob.mx/default.aspx?id=${id}&re=${re}&rr=${rr}&tt=${tt}&fe=${fe}`;

  // Mostrar resultados
  document.getElementById("urlCorregida").textContent = urlFinal;
  document.getElementById("abrir").href = urlFinal;

  document.getElementById("id").value = id;
  document.getElementById("re").value = re;
  document.getElementById("rr").value = rr;
  document.getElementById("tt").value = tt;
  document.getElementById("fe").value = fe;

  document.getElementById("resultado").style.display = "block";
}
</script>

</body>
</html>

